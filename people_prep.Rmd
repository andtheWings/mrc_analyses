---
title: "mrc_people_prep"
author: "Daniel P. Hall Riggins, MD"
date: "10/5/2021"
output: html_document
---

```{r}
library(arrow)
library(tidyverse)
```

```{r}
all_raw <- read_csv("data/MRC_ALL_DATA_LABELS_2021-09-30_1556.csv")
```

```{r}
people_prep <- function(source, columns) {
    print(
        paste0(
            "Initial number of records is ",
            nrow(source)
        )
    )
    distinct1 <- distinct(source)
    print(
        paste0(
            "Which reduces to ",
            nrow(distinct1),
            " when filtering for distinct rows"
        )
    )
    select2 <- select({{distinct1}}, {{columns}})
    distinct3 <- distinct(select2)
    print(
        paste0(
            "Which reduces to ",
            nrow(distinct3),
            " when filtering for distinct rows after selecting columns of interest"
        )
    )
    return(distinct3)
}
```

```{r}
people_columns <- c(
    mrc_id = "Record ID", 
    last_name = "Client Last Name...55", 
    first_name = "Client First Name...56", 
    other_name = "Client Other name", 
    dob = "Client DOB...58", 
    sex = "Sex", 
    black = "What is your race? (choice=Black)", 
    white = "What is your race? (choice=White)",
    asian = "What is your race? (choice=Asian/American Indian or Alaska native)",
    pacific = "What is your race? (choice=Native Hawaiian or Pacific Islander)",
    multiracial = "What is your race? (choice=Multiracial)",
    other_race = "What is your race? (choice=Other)",
    hispanic = "Do you consider yourself Hispanic or Latinx?",
    mrc_admission_date = "MI1:Registration Date",
    mrc_discharge_date = "Discharge Date"
)

mrc_people <- people_prep(all_raw, people_columns) %>%
    group_by(mrc_id) %>%
    summarize(
        across(
            .cols = last_name:mrc_admission_date,
            .fns = ~ first(.x)
        ),
        mrc_discharge_date = last(mrc_discharge_date)
    ) %>%
    filter(
        !is.na(mrc_admission_date)
    ) %>%
    mutate(
        sex = as_factor(sex),
        across(
            .cols = black:hispanic,
            .fns = ~ case_when(
                .x %in% c("Checked", "Yes") ~ TRUE,
                .x %in% c("Unchecked", "No") ~ FALSE
            )
        )
    )
```

```{r}
str(mrc_people)
```

